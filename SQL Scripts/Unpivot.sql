WITH DEMS AS (
    WITH DEMAND AS (
    SELECT 	
    	  BDTENR AS PART
        ,BDLOFL AS ORDER_NUMBER
    	  ,DEMANDCOL
    	  ,DEMANDQTY AS QTY
        ,'DEMAND' AS TYPE
        ,BDTART
    FROM 
    	BDDA
    UNPIVOT 
    (DEMANDQTY FOR DEMANDCOL IN ( BDB001,BDB002,BDB003,BDB004,BDB005,BDB006,BDB007,BDB008,BDB009,
    BDB010,BDB011,BDB012,BDB013,BDB014,BDB015,BDB016,BDB017,BDB018,BDB019,BDB020,BDB021,BDB022,
    BDB023,BDB024,BDB025,BDB026,BDB027,BDB028,BDB029,BDB030,BDB031,BDB032,BDB033,BDB034,BDB035,
    BDB036,BDB037,BDB038,BDB039,BDB040,BDB041,BDB042,BDB043,BDB044,BDB045,BDB046,BDB047,BDB048,
    BDB049,BDB050,BDB051,BDB052,BDB053,BDB054,BDB055,BDB056,BDB057,BDB058,BDB059,BDB060,BDB061,
    BDB062,BDB063,BDB064,BDB065,BDB066,BDB067,BDB068,BDB069,BDB070,BDB071,BDB072,BDB073,BDB074,
    BDB075,BDB076,BDB077,BDB078,BDB079,BDB080,BDB081,BDB082,BDB083,BDB084,BDB085,BDB086,BDB087,
    BDB088,BDB089,BDB090,BDB091,BDB092,BDB093,BDB094,BDB095,BDB096,BDB097,BDB098,BDB099,BDB100,
    BDB101,BDB102,BDB103,BDB104,BDB105,BDB106,BDB107,BDB108,BDB109,BDB110,BDB111,BDB112,BDB113,
    BDB114,BDB115,BDB116,BDB117,BDB118,BDB119,BDB120
    ))
    WHERE 
    DEMANDQTY > 0
    ),
    DATES AS (
        SELECT 	
    	DATECOL
    	,DATES
    	,ROW_NUMBER () OVER( ORDER BY DATECOL ASC) AS DATES_ROW
    FROM 
    	BDPA
    UNPIVOT 
    (DATES FOR DATECOL IN ( PBT001,PBT002,PBT003,PBT004,PBT005,PBT006,PBT007,PBT008,PBT009,
    PBT010,PBT011,PBT012,PBT013,PBT014,PBT015,PBT016,PBT017,PBT018,PBT019,PBT020,PBT021,PBT022,
    PBT023,PBT024,PBT025,PBT026,PBT027,PBT028,PBT029,PBT030,PBT031,PBT032,PBT033,PBT034,PBT035,
    PBT036,PBT037,PBT038,PBT039,PBT040,PBT041,PBT042,PBT043,PBT044,PBT045,PBT046,PBT047,PBT048,
    PBT049,PBT050,PBT051,PBT052,PBT053,PBT054,PBT055,PBT056,PBT057,PBT058,PBT059,PBT060,PBT061,
    PBT062,PBT063,PBT064,PBT065,PBT066,PBT067,PBT068,PBT069,PBT070,PBT071,PBT072,PBT073,PBT074,
    PBT075,PBT076,PBT077,PBT078,PBT079,PBT080,PBT081,PBT082,PBT083,PBT084,PBT085,PBT086,PBT087,
    PBT088,PBT089,PBT090,PBT091,PBT092,PBT093,PBT094,PBT095,PBT096,PBT097,PBT098,PBT099,PBT100,
    PBT101,PBT102,PBT103,PBT104,PBT105,PBT106,PBT107,PBT108,PBT109,PBT110,PBT111,PBT112,PBT113,
    PBT114,PBT115,PBT116,PBT117,PBT118,PBT119,PBT120
    ))
    )
    SELECT 
        ORDER_NUMBER
        ,PART
        ,QTY
        ,TYPE
        ,TRY_TO_DATE(TO_CHAR(DATES),'YYYYMMDD') AS MRP_DUE_DATE
        ,BDTART
    FROM 
        DEMAND
    LEFT JOIN 
        DATES ON
            RIGHT(DEMANDCOL,3) = RIGHT(DATECOL,3)
)
,NON AS (
    WITH NONSDEMAND AS (
        SELECT 	
        	BDTENR AS PART
            ,'NONSERIAL' AS ORDER_NUMBER
        	,NONCOL
        	,NONQTY AS QTY
            ,'DEMAND' AS TYPE
            ,BDTART
        FROM 
        	BDDA
        UNPIVOT 
        (NONQTY FOR NONCOL IN ( BDR001,BDR002,BDR003,BDR004,BDR005,BDR006,BDR007,BDR008,BDR009,
        BDR010,BDR011,BDR012,BDR013,BDR014,BDR015,BDR016,BDR017,BDR018,BDR019,BDR020,BDR021,BDR022,
        BDR023,BDR024,BDR025,BDR026,BDR027,BDR028,BDR029,BDR030,BDR031,BDR032,BDR033,BDR034,BDR035,
        BDR036,BDR037,BDR038,BDR039,BDR040,BDR041,BDR042,BDR043,BDR044,BDR045,BDR046,BDR047,BDR048,
        BDR049,BDR050,BDR051,BDR052,BDR053,BDR054,BDR055,BDR056,BDR057,BDR058,BDR059,BDR060,BDR061,
        BDR062,BDR063,BDR064,BDR065,BDR066,BDR067,BDR068,BDR069,BDR070,BDR071,BDR072,BDR073,BDR074,
        BDR075,BDR076,BDR077,BDR078,BDR079,BDR080,BDR081,BDR082,BDR083,BDR084,BDR085,BDR086,BDR087,
        BDR088,BDR089,BDR090,BDR091,BDR092,BDR093,BDR094,BDR095,BDR096,BDR097,BDR098,BDR099,BDR100,
        BDR101,BDR102,BDR103,BDR104,BDR105,BDR106,BDR107,BDR108,BDR109,BDR110,BDR111,BDR112,BDR113,
        BDR114,BDR115,BDR116,BDR117,BDR118,BDR119,BDR120
        ))
        WHERE
        NONQTY > 0
        ),
        DATES AS (
            SELECT 	
        	DATECOL
        	,DATES
        	,ROW_NUMBER () OVER( ORDER BY DATECOL ASC) AS DATES_ROW
        FROM 
        	BDPA
        UNPIVOT 
        (DATES FOR DATECOL IN ( PBT001,PBT002,PBT003,PBT004,PBT005,PBT006,PBT007,PBT008,PBT009,
        PBT010,PBT011,PBT012,PBT013,PBT014,PBT015,PBT016,PBT017,PBT018,PBT019,PBT020,PBT021,PBT022,
        PBT023,PBT024,PBT025,PBT026,PBT027,PBT028,PBT029,PBT030,PBT031,PBT032,PBT033,PBT034,PBT035,
        PBT036,PBT037,PBT038,PBT039,PBT040,PBT041,PBT042,PBT043,PBT044,PBT045,PBT046,PBT047,PBT048,
        PBT049,PBT050,PBT051,PBT052,PBT053,PBT054,PBT055,PBT056,PBT057,PBT058,PBT059,PBT060,PBT061,
        PBT062,PBT063,PBT064,PBT065,PBT066,PBT067,PBT068,PBT069,PBT070,PBT071,PBT072,PBT073,PBT074,
        PBT075,PBT076,PBT077,PBT078,PBT079,PBT080,PBT081,PBT082,PBT083,PBT084,PBT085,PBT086,PBT087,
        PBT088,PBT089,PBT090,PBT091,PBT092,PBT093,PBT094,PBT095,PBT096,PBT097,PBT098,PBT099,PBT100,
        PBT101,PBT102,PBT103,PBT104,PBT105,PBT106,PBT107,PBT108,PBT109,PBT110,PBT111,PBT112,PBT113,
        PBT114,PBT115,PBT116,PBT117,PBT118,PBT119,PBT120
        ))
        )
        SELECT 
            ORDER_NUMBER
            ,PART
            ,QTY
            ,TYPE
            ,TRY_TO_DATE(TO_CHAR(DATES),'YYYYMMDD') AS MRP_DUE_DATE
            ,BDTART
        FROM 
            NONSDEMAND
        LEFT JOIN 
            DATES ON
                RIGHT(NONCOL,3) = RIGHT(DATECOL,3)
)
,SUPP AS (
    WITH SUPPLY AS (
        SELECT 	
        	BDTENR AS PART
          ,BDLOFL AS ORDER_NUMBER
        	,SUPPLYCOL
        	,SUPPLYQTY AS QTY
          ,TYPECOL
          ,TYPE
          ,CASE
              WHEN TYPE = '' THEN 'SUPPLY'
              WHEN TYPE IN ('P','?') THEN 'SUPPLYP' 
                  ELSE TYPE 
              END AS TYPE
          ,BDTART
        FROM 
        	BDDA
        UNPIVOT
        (SUPPLYQTY FOR SUPPLYCOL IN (BDO001,BDO002,BDO003,BDO004,BDO005,BDO006,BDO007,BDO008,BDO009,
        BDO010,BDO011,BDO012,BDO013,BDO014,BDO015,BDO016,BDO017,BDO018,BDO019,BDO020,BDO021,BDO022,
        BDO023,BDO024,BDO025,BDO026,BDO027,BDO028,BDO029,BDO030,BDO031,BDO032,BDO033,BDO034,BDO035,
        BDO036,BDO037,BDO038,BDO039,BDO040,BDO041,BDO042,BDO043,BDO044,BDO045,BDO046,BDO047,BDO048,
        BDO049,BDO050,BDO051,BDO052,BDO053,BDO054,BDO055,BDO056,BDO057,BDO058,BDO059,BDO060,BDO061,
        BDO062,BDO063,BDO064,BDO065,BDO066,BDO067,BDO068,BDO069,BDO070,BDO071,BDO072,BDO073,BDO074,
        BDO075,BDO076,BDO077,BDO078,BDO079,BDO080,BDO081,BDO082,BDO083,BDO084,BDO085,BDO086,BDO087,
        BDO088,BDO089,BDO090,BDO091,BDO092,BDO093,BDO094,BDO095,BDO096,BDO097,BDO098,BDO099,BDO100,
        BDO101,BDO102,BDO103,BDO104,BDO105,BDO106,BDO107,BDO108,BDO109,BDO110,BDO111,BDO112,BDO113,
        BDO114,BDO115,BDO116,BDO117,BDO118,BDO119,BDO120
        ))
        UNPIVOT
        (TYPE FOR TYPECOL IN (BDF001,BDF002,BDF003,BDF004,BDF005,BDF006,BDF007,BDF008,BDF009,
        BDF010,BDF011,BDF012,BDF013,BDF014,BDF015,BDF016,BDF017,BDF018,BDF019,BDF020,BDF021,BDF022,
        BDF023,BDF024,BDF025,BDF026,BDF027,BDF028,BDF029,BDF030,BDF031,BDF032,BDF033,BDF034,BDF035,
        BDF036,BDF037,BDF038,BDF039,BDF040,BDF041,BDF042,BDF043,BDF044,BDF045,BDF046,BDF047,BDF048,
        BDF049,BDF050,BDF051,BDF052,BDF053,BDF054,BDF055,BDF056,BDF057,BDF058,BDF059,BDF060,BDF061,
        BDF062,BDF063,BDF064,BDF065,BDF066,BDF067,BDF068,BDF069,BDF070,BDF071,BDF072,BDF073,BDF074,
        BDF075,BDF076,BDF077,BDF078,BDF079,BDF080,BDF081,BDF082,BDF083,BDF084,BDF085,BDF086,BDF087,
        BDF088,BDF089,BDF090,BDF091,BDF092,BDF093,BDF094,BDF095,BDF096,BDF097,BDF098,BDF099,BDF100,
        BDF101,BDF102,BDF103,BDF104,BDF105,BDF106,BDF107,BDF108,BDF109,BDF110,BDF111,BDF112,BDF113,
        BDF114,BDF115,BDF116,BDF117,BDF118,BDF119,BDF120
        ))
        WHERE
        SUPPLYQTY > 0
        AND RIGHT(SUPPLYCOL,3) = RIGHT(TYPECOL,3)
        AND BDTART IN ('2','3','9')
        ),
        DATES AS (
            SELECT 	
        	DATECOL
        	,DATES
        	,ROW_NUMBER () OVER( ORDER BY DATECOL ASC) AS DATES_ROW
        FROM 
        	BDPA
        UNPIVOT 
        (DATES FOR DATECOL IN ( PBT001,PBT002,PBT003,PBT004,PBT005,PBT006,PBT007,PBT008,PBT009,
        PBT010,PBT011,PBT012,PBT013,PBT014,PBT015,PBT016,PBT017,PBT018,PBT019,PBT020,PBT021,PBT022,
        PBT023,PBT024,PBT025,PBT026,PBT027,PBT028,PBT029,PBT030,PBT031,PBT032,PBT033,PBT034,PBT035,
        PBT036,PBT037,PBT038,PBT039,PBT040,PBT041,PBT042,PBT043,PBT044,PBT045,PBT046,PBT047,PBT048,
        PBT049,PBT050,PBT051,PBT052,PBT053,PBT054,PBT055,PBT056,PBT057,PBT058,PBT059,PBT060,PBT061,
        PBT062,PBT063,PBT064,PBT065,PBT066,PBT067,PBT068,PBT069,PBT070,PBT071,PBT072,PBT073,PBT074,
        PBT075,PBT076,PBT077,PBT078,PBT079,PBT080,PBT081,PBT082,PBT083,PBT084,PBT085,PBT086,PBT087,
        PBT088,PBT089,PBT090,PBT091,PBT092,PBT093,PBT094,PBT095,PBT096,PBT097,PBT098,PBT099,PBT100,
        PBT101,PBT102,PBT103,PBT104,PBT105,PBT106,PBT107,PBT108,PBT109,PBT110,PBT111,PBT112,PBT113,
        PBT114,PBT115,PBT116,PBT117,PBT118,PBT119,PBT120
        ))
        )
        SELECT 
            ORDER_NUMBER
            ,PART
            ,QTY
            ,TYPE
            ,TRY_TO_DATE(TO_CHAR(DATES),'YYYYMMDD') AS MRP_DUE_DATE
            ,BDTART
        FROM 
            SUPPLY
        LEFT JOIN 
            DATES ON
                RIGHT(SUPPLYCOL,3) = RIGHT(DATECOL,3)
)
,BDVSUPP AS (
     WITH BDV AS (
            SELECT 	
            	BDTENR AS PART
                ,BDLOFL AS ORDER_NUMBER
            	,BDVCOL
            	,BDVQTY AS QTY
                ,'SUPPLY' AS TYPE
                ,BDTART
            FROM 
            	BDDA
            UNPIVOT
            (BDVQTY FOR BDVCOL IN (BDV001,BDV002,BDV003,BDV004,BDV005,BDV006,BDV007,BDV008,BDV009,
            BDV010,BDV011,BDV012,BDV013,BDV014,BDV015,BDV016,BDV017,BDV018,BDV019,BDV020,BDV021,BDV022,
            BDV023,BDV024,BDV025,BDV026,BDV027,BDV028,BDV029,BDV030,BDV031,BDV032,BDV033,BDV034,BDV035,
            BDV036,BDV037,BDV038,BDV039,BDV040,BDV041,BDV042,BDV043,BDV044,BDV045,BDV046,BDV047,BDV048,
            BDV049,BDV050,BDV051,BDV052,BDV053,BDV054,BDV055,BDV056,BDV057,BDV058,BDV059,BDV060,BDV061,
            BDV062,BDV063,BDV064,BDV065,BDV066,BDV067,BDV068,BDV069,BDV070,BDV071,BDV072,BDV073,BDV074,
            BDV075,BDV076,BDV077,BDV078,BDV079,BDV080,BDV081,BDV082,BDV083,BDV084,BDV085,BDV086,BDV087,
            BDV088,BDV089,BDV090,BDV091,BDV092,BDV093,BDV094,BDV095,BDV096,BDV097,BDV098,BDV099,BDV100,
            BDV101,BDV102,BDV103,BDV104,BDV105,BDV106,BDV107,BDV108,BDV109,BDV110,BDV111,BDV112,BDV113,
            BDV114,BDV115,BDV116,BDV117,BDV118,BDV119,BDV120
            ))
            WHERE
            BDVQTY > 0
            AND BDTART IN ('1','4')
            ),
            DATES AS (
                SELECT 	
            	DATECOL
            	,DATES
            	,ROW_NUMBER () OVER( ORDER BY DATECOL ASC) AS DATES_ROW
            FROM 
            	BDPA
            UNPIVOT 
            (DATES FOR DATECOL IN ( PBT001,PBT002,PBT003,PBT004,PBT005,PBT006,PBT007,PBT008,PBT009,
            PBT010,PBT011,PBT012,PBT013,PBT014,PBT015,PBT016,PBT017,PBT018,PBT019,PBT020,PBT021,PBT022,
            PBT023,PBT024,PBT025,PBT026,PBT027,PBT028,PBT029,PBT030,PBT031,PBT032,PBT033,PBT034,PBT035,
            PBT036,PBT037,PBT038,PBT039,PBT040,PBT041,PBT042,PBT043,PBT044,PBT045,PBT046,PBT047,PBT048,
            PBT049,PBT050,PBT051,PBT052,PBT053,PBT054,PBT055,PBT056,PBT057,PBT058,PBT059,PBT060,PBT061,
            PBT062,PBT063,PBT064,PBT065,PBT066,PBT067,PBT068,PBT069,PBT070,PBT071,PBT072,PBT073,PBT074,
            PBT075,PBT076,PBT077,PBT078,PBT079,PBT080,PBT081,PBT082,PBT083,PBT084,PBT085,PBT086,PBT087,
            PBT088,PBT089,PBT090,PBT091,PBT092,PBT093,PBT094,PBT095,PBT096,PBT097,PBT098,PBT099,PBT100,
            PBT101,PBT102,PBT103,PBT104,PBT105,PBT106,PBT107,PBT108,PBT109,PBT110,PBT111,PBT112,PBT113,
            PBT114,PBT115,PBT116,PBT117,PBT118,PBT119,PBT120
            ))
            )
            SELECT 
                ORDER_NUMBER
                ,PART
                ,QTY
                ,TYPE
                ,TRY_TO_DATE(TO_CHAR(DATES),'YYYYMMDD') AS MRP_DUE_DATE
                ,BDTART
            FROM 
                BDV
            LEFT JOIN 
                DATES ON
                    RIGHT(BDVCOL,3) = RIGHT(DATECOL,3)
)
SELECT 
    ORDER_NUMBER
    ,BDTART
    ,NULL AS ORDER_LINE
    ,QTY
    ,MRP_DUE_DATE
    ,TYPE
    ,'3' AS MRP_DOMAIN
    ,PART
    ,'GITHUB'||'~'||MRP_DOMAIN||'~'||MRP_DOMAIN||'~'||PART AS SITE_PART_KEY
    ,'GITHUB'||'~'||MRP_DOMAIN||'~'||MRP_DOMAIN AS SITE_KEY
FROM 
    DEMS
UNION ALL 
SELECT 
    ORDER_NUMBER
    ,BDTART
    ,NULL AS ORDER_LINE
    ,QTY
    ,MRP_DUE_DATE
    ,TYPE
    ,'3' AS MRP_DOMAIN
    ,PART
    ,'GITHUB'||'~'||MRP_DOMAIN||'~'||MRP_DOMAIN||'~'||PART AS MRP_DOMAIN_SITE_PART_KEY
    ,'GITHUB'||'~'||MRP_DOMAIN||'~'||MRP_DOMAIN AS MRP_DOMAIN_SITE_KEY
FROM 
    SUPP
UNION ALL 
SELECT 
    ORDER_NUMBER
    ,BDTART
    ,NULL AS ORDER_LINE
    ,QTY
    ,MRP_DUE_DATE
    ,TYPE
    ,'3' AS MRP_DOMAIN
    ,PART
    ,'GITHUB'||'~'||MRP_DOMAIN||'~'||MRP_DOMAIN||'~'||PART AS MRP_DOMAIN_SITE_PART_KEY
    ,'GITHUB'||'~'||MRP_DOMAIN||'~'||MRP_DOMAIN AS MRP_DOMAIN_SITE_KEY
FROM 
    NON
UNION ALL 
SELECT 
    ORDER_NUMBER
    ,BDTART
    ,NULL AS ORDER_LINE
    ,QTY
    ,MRP_DUE_DATE
    ,TYPE
    ,'3' AS MRP_DOMAIN
    ,PART
    ,NULL AS 
    ,'GITHUB'||'~'||MRP_DOMAIN||'~'||MRP_DOMAIN||'~'||PART AS MRP_DOMAIN_SITE_PART_KEY
    ,'GITHUB'||'~'||MRP_DOMAIN||'~'||MRP_DOMAIN AS MRP_DOMAIN_SITE_KEY
FROM 
    BDVSUPP
